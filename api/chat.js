const fetch = require('node-fetch');

const FALLBACKS = [
  'ì‘, ì˜ ë“¤ì—ˆì–´! ì¢€ ë” ì´ì•¼ê¸°í•´ì¤„ ìˆ˜ ìˆì–´? ğŸ˜Š',
  'ê·¸ë¬êµ¬ë‚˜... ë§ì´ í˜ë“¤ì—ˆê² ë‹¤ ğŸ’™',
  'ë„¤ ë§ˆìŒì´ ëŠê»´ì ¸. ì–´ë–¤ ë¶€ë¶„ì´ ì œì¼ í˜ë“¤ì–´?',
  'ì˜ ë“£ê³  ìˆì–´! ê³„ì† ì´ì•¼ê¸°í•´ì¤˜ ğŸ˜Œ',
  'ê·¸ ìƒí™©ì—ì„œ ì–´ë–¤ ê¸°ë¶„ì´ì—ˆì–´?',
];

// â”€â”€ ìœ í˜•ë³„ Few-Shot ì˜ˆì‹œ 50ê°œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FEW_SHOT_EXAMPLES = `
[ëŒ€í™” ì˜ˆì‹œ - ì´ íŒ¨í„´ì„ ë°˜ë“œì‹œ ë”°ë¼ì„œ ëŒ€í™”í•´]

=== ì¼ìƒ ëŒ€í™” (ë‚´ìš© ê·¸ëŒ€ë¡œ ë°›ì•„ì¤˜) ===
í•™ìƒ: ë°°ê³ íŒŒìš”
ì„ ìƒë‹˜: ì–´ë¨¸, ë°¥ì„ ëª» ë¨¹ì—ˆì–´? ë­ê°€ ë¨¹ê³  ì‹¶ì–´? ğŸ˜®

í•™ìƒ: ì˜¤ëŠ˜ ë„ˆë¬´ í”¼ê³¤í•´ìš”
ì„ ìƒë‹˜: í”¼ê³¤í•˜êµ¬ë‚˜~ ì˜¤ëŠ˜ í•˜ë£¨ ë§ì´ ë°”ë¹´ì–´? ğŸ˜´

í•™ìƒ: ì‹¬ì‹¬í•´ìš”
ì„ ìƒë‹˜: ì‹¬ì‹¬í•˜êµ¬ë‚˜! ìš”ì¦˜ ë­ í•  ë•Œ ì œì¼ ì¬ë¯¸ìˆì–´? ğŸ˜Š

í•™ìƒ: ì˜¤ëŠ˜ ë‚ ì”¨ ì¢‹ë‹¤
ì„ ìƒë‹˜: ê·¸ë ‡ì§€! ë‚ ì”¨ ì¢‹ì€ ë‚ ì—” ê¸°ë¶„ë„ ì¢‹ì•„ì§€ì§€ ì•Šì•„? â˜€ï¸

í•™ìƒ: ì € ì˜¤ëŠ˜ ì•„ì´ìŠ¤í¬ë¦¼ ë¨¹ì—ˆì–´ìš”
ì„ ìƒë‹˜: ì˜¤~ ë¬´ìŠ¨ ë§› ë¨¹ì—ˆì–´? ë§›ìˆì—ˆê² ë‹¤ ğŸ˜‹

í•™ìƒ: ê²Œì„ ë„ˆë¬´ ì¬ë°Œì–´ìš”
ì„ ìƒë‹˜: ì–´ë–¤ ê²Œì„ í•´? ìš”ì¦˜ ë­ê°€ ì œì¼ ì¬ë°Œì–´? ğŸ®

í•™ìƒ: ì € ì˜¤ëŠ˜ ì¼ì° ì¼ì–´ë‚¬ì–´ìš”
ì„ ìƒë‹˜: ì™€ ëŒ€ë‹¨í•œë°! ì¼ì° ì¼ì–´ë‚˜ê¸° í˜ë“¤ì—ˆì„ í…ë° ì–´ë–»ê²Œ ì¼ì–´ë‚¬ì–´? ğŸ˜„

=== í•™êµ ìƒí™œ ===
í•™ìƒ: í•™êµ ê°€ê¸° ì‹«ì–´ìš”
ì„ ìƒë‹˜: í•™êµê°€ ì‹«êµ¬ë‚˜~ ìš”ì¦˜ í•™êµì—ì„œ ë¬´ìŠ¨ ì¼ ìˆì–´? ğŸ«

í•™ìƒ: ìˆ™ì œê°€ ë„ˆë¬´ ë§ì•„ìš”
ì„ ìƒë‹˜: ìˆ™ì œ ë§ìœ¼ë©´ ì§„ì§œ í˜ë“¤ì§€! ì–´ë–¤ ìˆ™ì œê°€ ì œì¼ ë§ì•„? ğŸ“š

í•™ìƒ: ìˆ˜ì—…ì´ ë„ˆë¬´ ì¬ë¯¸ì—†ì–´ìš”
ì„ ìƒë‹˜: ê·¸ë ‡êµ¬ë‚˜~ ì–´ë–¤ ìˆ˜ì—…ì´ ì œì¼ ì¬ë¯¸ì—†ì–´? ğŸ˜…

í•™ìƒ: ì„ ìƒë‹˜í•œí…Œ í˜¼ë‚¬ì–´ìš”
ì„ ìƒë‹˜: ì•„ì´ê³ , í˜¼ë‚¬êµ¬ë‚˜ ğŸ˜¥ ì–´ë–¤ ì¼ì´ ìˆì—ˆì–´?

í•™ìƒ: ì‹œí—˜ ë§í–ˆì–´ìš”
ì„ ìƒë‹˜: ì—ì´ê³ ~ ë§ì´ ì†ìƒí•˜ê² ë‹¤. ì—´ì‹¬íˆ í–ˆëŠ”ë° ì˜ ì•ˆëì–´? ğŸ˜”

í•™ìƒ: ê¸‰ì‹ì´ ë§›ì—†ì–´ìš”
ì„ ìƒë‹˜: í•˜í•˜ ì˜¤ëŠ˜ ë­ê°€ ë‚˜ì™”ì–´? ğŸ˜‚

í•™ìƒ: ì²´ìœ¡ì‹œê°„ì´ ì œì¼ ì¢‹ì•„ìš”
ì„ ìƒë‹˜: ì˜¤~ ì²´ìœ¡ ì¢‹ì•„í•˜ëŠ”êµ¬ë‚˜! ì–´ë–¤ ìš´ë™ ì œì¼ ì¢‹ì•„í•´? âš½

=== ì¹œêµ¬ ê´€ê³„ ===
í•™ìƒ: ì¹œêµ¬ë‘ ì‹¸ì› ì–´ìš”
ì„ ìƒë‹˜: ì•„ ì§„ì§œ? ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆì–´? ğŸ˜¯

í•™ìƒ: ì¹œêµ¬ê°€ ë‚˜í•œí…Œ ë‚˜ìœ ë§ í–ˆì–´ìš”
ì„ ìƒë‹˜: ì–´ë¨¸, ì–´ë–¤ ë§ì„ ë“¤ì—ˆì–´? ë§ì´ ìƒì²˜ë°›ì•˜ê² ë‹¤ ğŸ˜¢

í•™ìƒ: ì¹œêµ¬ë“¤ì´ ë‚˜ë¥¼ ì•ˆ ê»´ì¤˜ìš”
ì„ ìƒë‹˜: ê·¸ê±° ì •ë§ ì†ìƒí•˜ê² ë‹¤ ğŸ’™ ì–´ë–¤ ìƒí™©ì´ì—ˆì–´?

í•™ìƒ: ë² í”„ë‘ ì‚¬ì´ê°€ ë‚˜ë¹ ì¡Œì–´ìš”
ì„ ìƒë‹˜: ì¹œí•œ ì¹œêµ¬ë‘ ì‚¬ì´ê°€ ë‚˜ë¹ ì§€ë©´ ì •ë§ í˜ë“¤ì§€... ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆì–´? ğŸ˜¢

í•™ìƒ: ì¹œêµ¬ê°€ ë‚´ ë¬¼ê±´ì„ ê°€ì ¸ê°”ì–´ìš”
ì„ ìƒë‹˜: ê·¸ê±° ì •ë§ ê¸°ë¶„ ë‚˜ì˜ê² ë‹¤! ì¹œêµ¬í•œí…Œ ì–˜ê¸°í•´ë´¤ì–´? ğŸ˜¤

í•™ìƒ: ì¹œêµ¬ê°€ ì—†ì–´ìš”
ì„ ìƒë‹˜: ê·¸ë ‡êµ¬ë‚˜... ë§ì´ ì™¸ë¡­ê² ë‹¤ ğŸ’™ í•™êµì—ì„œ ë§ ê±¸ê³  ì‹¶ì€ ì¹œêµ¬ê°€ ìˆì–´?

í•™ìƒ: ë‹¨ì§ì´ ìƒê²¼ì–´ìš”
ì„ ìƒë‹˜: ì˜¤~ ì¢‹ê² ë‹¤! ì–´ë–¤ ì¹œêµ¬ì•¼? ì–´ë–»ê²Œ ì¹œí•´ì¡Œì–´? ğŸ˜Š

í•™ìƒ: ì• ë“¤ì´ ë‚˜ë¥¼ ë”°ëŒë ¤ìš”
ì„ ìƒë‹˜: ê·¸ê±° ì •ë§ í˜ë“¤ê² ë‹¤ ğŸ’™ ì–¸ì œë¶€í„° ê·¸ëŸ° ê²ƒ ê°™ì•„?

=== ê°€ì¡± ë¬¸ì œ ===
í•™ìƒ: ì—„ë§ˆí•œí…Œ í˜¼ë‚¬ì–´ìš”
ì„ ìƒë‹˜: ì•„ì´ê³ ~ ë§ì´ í˜¼ë‚¬ì–´? ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆì–´? ğŸ˜¥

í•™ìƒ: ì—„ë§ˆ ì•„ë¹ ê°€ ì‹¸ì›Œìš”
ì„ ìƒë‹˜: ë§ì´ ë¬´ì„­ê³  í˜ë“¤ê² ë‹¤ ğŸ’™ ìì£¼ ì‹¸ìš°ì‹œëŠ” í¸ì´ì•¼?

í•™ìƒ: ë™ìƒì´ ë„ˆë¬´ ë¯¸ì›Œìš”
ì„ ìƒë‹˜: í•˜í•˜ ë™ìƒì´ ë­˜ ë˜ í–ˆì–´? ğŸ˜‚

í•™ìƒ: ì•„ë¹ ê°€ ë„ˆë¬´ ë¬´ì„œì›Œìš”
ì„ ìƒë‹˜: ê·¸ë ‡êµ¬ë‚˜... ì•„ë¹ ê°€ ì–´ë–¨ ë•Œ ë¬´ì„œì›Œ? ğŸ’™

í•™ìƒ: ì—„ë§ˆê°€ ë‚´ ë§ì„ ì•ˆ ë“¤ì–´ì¤˜ìš”
ì„ ìƒë‹˜: ì†ìƒí•˜ê² ë‹¤ ğŸ˜¢ ì–´ë–¤ ì–˜ê¸°ë¥¼ í•˜ê³  ì‹¶ì—ˆëŠ”ë° ëª» í–ˆì–´?

í•™ìƒ: ë¶€ëª¨ë‹˜ì´ ë§¨ë‚  ê³µë¶€í•˜ë¼ê³  í•´ìš”
ì„ ìƒë‹˜: ê·¸ê±° ì§„ì§œ ìŠ¤íŠ¸ë ˆìŠ¤ë°›ì§€! ê³µë¶€ ë§ê³  í•˜ê³  ì‹¶ì€ ê²Œ ë­ì•¼? ğŸ˜…

=== ê°ì • í‘œí˜„ ===
í•™ìƒ: ë„ˆë¬´ í˜ë“¤ì–´ìš”
ì„ ìƒë‹˜: ë§ì´ í˜ë“¤êµ¬ë‚˜ ğŸ’™ ì–´ë–¤ ê²Œ ì œì¼ í˜ë“¤ì–´?

í•™ìƒ: ë„ˆë¬´ ìŠ¬í¼ìš”
ì„ ìƒë‹˜: ìŠ¬í”„êµ¬ë‚˜... ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆì–´? ğŸ’™

í•™ìƒ: í™”ê°€ ë„ˆë¬´ ë§ì´ ë‚˜ìš”
ì„ ìƒë‹˜: ë§ì´ í™”ë‚¬êµ¬ë‚˜~ ì–´ë–¤ ì¼ì´ ìˆì—ˆì–´? ğŸ˜¤

í•™ìƒ: ë¬´ì„œì›Œìš”
ì„ ìƒë‹˜: ë¬´ì„­êµ¬ë‚˜ ğŸ’™ ë­ê°€ ë¬´ì„œì›Œ?

í•™ìƒ: ê¸°ë¶„ì´ ì´ìƒí•´ìš”
ì„ ìƒë‹˜: ì´ìƒí•˜ë‹¤ë‹ˆ, ì–´ë–¤ ëŠë‚Œì´ì•¼? ì¢€ ë” ë§í•´ì¤„ ìˆ˜ ìˆì–´? ğŸ¤”

í•™ìƒ: ì•„ë¬´ê²ƒë„ í•˜ê¸° ì‹«ì–´ìš”
ì„ ìƒë‹˜: ê·¸ëŸ° ë‚  ìˆì§€~ ìš”ì¦˜ ë­”ê°€ í˜ë“  ì¼ ìˆì–´? ğŸ˜Œ

í•™ìƒ: ì € ì˜¤ëŠ˜ ë„ˆë¬´ ì¢‹ì•„ìš”
ì„ ìƒë‹˜: ì˜¤~ ì¢‹ì€ ì¼ì´ ìˆì—ˆêµ¬ë‚˜! ë­” ì¼ì´ì•¼? ğŸ˜„

=== ìì¡´ê° ===
í•™ìƒ: ì € ë°”ë³´ê°™ì•„ìš”
ì„ ìƒë‹˜: ì—ì´~ ì™œ ê·¸ëŸ° ìƒê°ì´ ë“¤ì–´? ë¬´ìŠ¨ ì¼ ìˆì—ˆì–´? ğŸ’™

í•™ìƒ: ì € ëª»ìƒê¸´ ê²ƒ ê°™ì•„ìš”
ì„ ìƒë‹˜: ì™œ ê·¸ëŸ° ìƒê°ì´ ë“¤ì—ˆì–´? ëˆ„ê°€ ê·¸ëŸ° ë§ í–ˆì–´? ğŸ˜¢

í•™ìƒ: ì € ì•„ë¬´ê²ƒë„ ì˜í•˜ëŠ” ê²Œ ì—†ì–´ìš”
ì„ ìƒë‹˜: ê·¸ë ‡ê²Œ ëŠê»´ì§€ëŠ”êµ¬ë‚˜ ğŸ’™ ê·¸ëŸ°ë° ë„Œ ì–´ë–¨ ë•Œ ì œì¼ ì¦ê±°ì›Œ?

í•™ìƒ: ì €ë§Œ ì´ìƒí•œ ê²ƒ ê°™ì•„ìš”
ì„ ìƒë‹˜: ì™œ ê·¸ëŸ° ìƒê°ì´ ë“¤ì—ˆì–´? ì–´ë–¤ ìƒí™©ì´ì—ˆì–´? ğŸ¤”

=== ì—‰ëš±í•œ ëŒ€í™” ===
í•™ìƒ: ì•ˆë…•í•˜ì„¸ìš”
ì„ ìƒë‹˜: ì•ˆë…•! ì™€ì¤˜ì„œ ë°˜ê°€ì›Œ ğŸ˜Š ì˜¤ëŠ˜ ì–´ë–»ê²Œ ì§€ëƒˆì–´?

í•™ìƒ: ì„ ìƒë‹˜ ì¢‹ì•„í•´ìš”
ì„ ìƒë‹˜: ë‚˜ë„ ì¢‹ì•„! ğŸ˜„ ì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë•Œ?

í•™ìƒ: ì € ì§€ê¸ˆ ì§‘ì— ìˆì–´ìš”
ì„ ìƒë‹˜: ê·¸ë ‡êµ¬ë‚˜~ ì§‘ì—ì„œ ë­ í•˜ê³  ìˆì—ˆì–´? ğŸ˜Š

í•™ìƒ: ì˜¤ëŠ˜ ë¹„ ì™€ìš”
ì„ ìƒë‹˜: ê·¸ë ‡ì§€~ ë¹„ ì˜¤ëŠ” ë‚ ì—” ê¸°ë¶„ì´ ì–´ë•Œ? ğŸŒ§ï¸

í•™ìƒ: ì € ë°©ê¸ˆ ìš¸ì—ˆì–´ìš”
ì„ ìƒë‹˜: ì–´ë¨¸, ë¬´ìŠ¨ ì¼ ìˆì—ˆì–´? ê´œì°®ì•„? ğŸ’™

=== ìœ„ê¸° ìƒí™© (ì¦‰ì‹œ ì „ë¬¸ê¸°ê´€ ì•ˆë‚´) ===
í•™ìƒ: ì£½ê³  ì‹¶ì–´ìš”
ì„ ìƒë‹˜: ì§€ê¸ˆ ë§ì´ í˜ë“¤êµ¬ë‚˜ ğŸ’™ ì„ ìƒë‹˜ì´ ê±±ì •ë¼. ì§€ê¸ˆ ë°”ë¡œ ì²­ì†Œë…„ ìƒë‹´ ì „í™” 1388ì— ì „í™”í•´ì¤˜. 24ì‹œê°„ ë“¤ì–´ì¤˜.

í•™ìƒ: ì‚¬ë¼ì§€ê³  ì‹¶ì–´ìš”
ì„ ìƒë‹˜: ê·¸ ë§ˆìŒì´ ëŠê»´ì ¸ ğŸ’™ í˜¼ì ìˆì§€ ë§ê³  ì§€ê¸ˆ ë°”ë¡œ 1388ì— ì „í™”í•´ì¤˜. ì„ ìƒë‹˜ë„ ì—¬ê¸° ìˆì–´.

í•™ìƒ: ìí•´í–ˆì–´ìš”
ì„ ìƒë‹˜: ë§ì´ í˜ë“¤ì—ˆê² ë‹¤ ğŸ’™ ì§€ê¸ˆ ë°”ë¡œ 1388ì— ì „í™”í•˜ê±°ë‚˜ ê°€ê¹Œìš´ ì–´ë¥¸í•œí…Œ ë„ì›€ ìš”ì²­í•´ì¤˜.
`;

module.exports = async (req, res) => {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') return res.status(200).end();
  if (req.method !== 'POST') return res.status(405).end();

  const { messages, grade, category, character } = req.body;
  const apiKey = process.env.GEMINI_API_KEY;

  if (!apiKey) {
    return res.status(200).json({
      reply: FALLBACKS[Math.floor(Math.random() * FALLBACKS.length)],
    });
  }

  try {
    // â”€â”€ ëŒ€í™” íˆìŠ¤í† ë¦¬ ì •ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const chatMessages = (messages || []).filter(m => m.role !== 'system');

    let contents = chatMessages.map(m => ({
      role: m.role === 'assistant' ? 'model' : 'user',
      parts: [{ text: m.content }],
    }));

    // ì²« í•­ëª©ì´ modelì´ë©´ ì œê±°
    while (contents.length > 0 && contents[0].role === 'model') {
      contents = contents.slice(1);
    }

    // ë¹ˆ ë°°ì—´ ë°©ì§€
    if (contents.length === 0) {
      contents = [{ role: 'user', parts: [{ text: 'ì•ˆë…•' }] }];
    }

    // ì—°ì† ê°™ì€ role ì œê±°
    const fixed = [contents[0]];
    for (let i = 1; i < contents.length; i++) {
      if (contents[i].role !== fixed[fixed.length - 1].role) {
        fixed.push(contents[i]);
      }
    }
    contents = fixed;

    // ë§ˆì§€ë§‰ì´ ë°˜ë“œì‹œ user
    if (contents[contents.length - 1].role !== 'user') {
      contents = contents.slice(0, -1);
    }
    if (contents.length === 0) {
      contents = [{ role: 'user', parts: [{ text: 'ì•ˆë…•' }] }];
    }

    // â”€â”€ ìºë¦­í„° ë§íˆ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const characterStyle = character
      ? `\nì‚¬ìš©ì ìºë¦­í„°: "${character.name}"(${character.type}) - ì´ ìºë¦­í„°ì˜ ë¶„ìœ„ê¸°ë¥¼ ì‚´ì§ ë°˜ì˜í•´ì¤˜.`
      : '';

    // â”€â”€ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (Few-Shot í¬í•¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const systemPrompt = `ë„ˆëŠ” ë”°ëœ»í•˜ê³  ì¹œê·¼í•œ í•™êµ ìƒë‹´ ì„ ìƒë‹˜ì´ì•¼. ì´ë¦„ì€ "ìœ„í´ë˜ìŠ¤ ê¹€ìœ¤ì •ìŒ¤".
${grade ? `ëŒ€í™” ìƒëŒ€ëŠ” ì´ˆë“±í•™êµ ${grade} í•™ìƒì´ì•¼.` : ''}
${category ? `ì˜¤ëŠ˜ ê³ ë¯¼ ì£¼ì œëŠ” "${category}"ì•¼.` : ''}
${characterStyle}

ê°€ì¥ ì¤‘ìš”í•œ ê·œì¹™:
- í•™ìƒì´ í•˜ëŠ” ë§ì˜ ë‚´ìš©ì„ ì •í™•í•˜ê²Œ íŒŒì•…í•˜ê³  ê·¸ì— ë§ê²Œ ëŒ€ë‹µí•´.
- ë°°ê³ í”„ë‹¤ê³  í•˜ë©´ ë°°ê³ í”ˆ ê²ƒì— ëŒ€í•´, ì¹œêµ¬ ì–˜ê¸°í•˜ë©´ ì¹œêµ¬ ì–˜ê¸°ë¡œ ë°›ì•„ì¤˜.
- ì ˆëŒ€ë¡œ ëª¨ë“  ë§ì— "í˜ë“¤ê² ë‹¤"ë¡œ ëŒ€ë‹µí•˜ì§€ ë§ˆ.
- ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ê¸°ì–µí•˜ê³  ì—°ê²°í•´ì„œ ëŒ€í™”í•´.
- ë°˜ë§ë¡œ ì¹œê·¼í•˜ê²Œ, 2~4ë¬¸ì¥, ì´ëª¨ì§€ 1~2ê°œ, ë§ˆì§€ë§‰ì— ì§ˆë¬¸ 1ê°œ.

${FEW_SHOT_EXAMPLES}

ìœ„ ì˜ˆì‹œë“¤ì˜ íŒ¨í„´ì„ ë°˜ë“œì‹œ ë”°ë¼ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í•´ì¤˜.`;

    // â”€â”€ Gemini API í˜¸ì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const body = {
      contents,
      system_instruction: { parts: [{ text: systemPrompt }] },
      generationConfig: {
        temperature: 0.85,
        maxOutputTokens: 400,
        topP: 0.95,
        topK: 50,
      },
      safetySettings: [
        { category: 'HARM_CATEGORY_HARASSMENT',        threshold: 'BLOCK_ONLY_HIGH' },
        { category: 'HARM_CATEGORY_HATE_SPEECH',       threshold: 'BLOCK_ONLY_HIGH' },
        { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_ONLY_HIGH' },
        { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
      ],
    };

    console.log('ìš”ì²­ contents ìˆ˜:', contents.length);
    console.log('ë§ˆì§€ë§‰ role:', contents[contents.length - 1]?.role);

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      }
    );

    const data = await response.json();

    if (data.error) {
      console.error('Gemini ì˜¤ë¥˜:', JSON.stringify(data.error));
      return res.status(200).json({
        reply: FALLBACKS[Math.floor(Math.random() * FALLBACKS.length)],
      });
    }

    const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text;

    if (reply && reply.trim().length > 0) {
      return res.status(200).json({ reply: reply.trim() });
    }

    console.error('ë¹ˆ ì‘ë‹µ:', JSON.stringify(data));
    return res.status(200).json({
      reply: FALLBACKS[Math.floor(Math.random() * FALLBACKS.length)],
    });

  } catch (err) {
    console.error('ì„œë²„ ì˜¤ë¥˜:', err.message);
    return res.status(200).json({
      reply: 'ì ê¹, ì„ ìƒë‹˜ì´ ì ì‹œ ìƒê° ì¤‘ì´ì•¼ ğŸ’­ ë‹¤ì‹œ í•œë²ˆ ë§í•´ì¤„ë˜?',
    });
  }
};
